<!DOCTYPE html>
<html>
<head>
  <title>COI Sanity Check</title>
  <style>
    body { font-family: sans-serif; padding: 1em; font-size: 16px; text-align: center; }
    #status-box { padding: 1em; border-radius: 8px; font-weight: bold; font-size: 1.2em; margin-top: 2em; }
    .loading { background-color: #ffc; color: #333; }
    .success { background-color: #cfc; color: #030; }
    .error { background-color: #fcc; color: #300; }
  </style>
</head>
<body>
  <h1>Cross-Origin Isolation Sanity Check</h1>
  <p>This page tests if a service worker can enable the required COOP/COEP headers.</p>
  <div id="status-box" class="loading">Initializing...</div>

  <script>
    // This script acts as a gatekeeper.
    (async () => {
      const statusEl = document.getElementById('status-box');

      function logStatus(message, type) {
        console.log(`[Sanity Check] ${message}`);
        statusEl.textContent = message;
        statusEl.className = type;
      }

      logStatus('Script started. Checking isolation status...', 'loading');

      // SUCCESS CONDITION: If the page is already isolated, we are done.
      if (window.crossOriginIsolated) {
        logStatus('SUCCESS: Environment is cross-origin isolated.', 'success');
        return;
      }

      // If not isolated, try to fix it with the service worker.
      if ('serviceWorker' in navigator) {
        logStatus('Environment NOT isolated. Setting up reload listener...', 'loading');
        
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          logStatus('Service worker has taken control. Reloading with cache-bust...', 'loading');
          const url = new URL(window.location.href);
          url.searchParams.set('cachebust', Date.now());
          window.location.href = url.href;
        });

        logStatus('Registering service worker...', 'loading');
        await navigator.serviceWorker.register('./coi-serviceworker.js', { scope: './' });

      } else {
        logStatus('ERROR: Service workers are not supported in this browser.', 'error');
      }
    })();
  </script>
</body>
</html>
