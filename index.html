<!DOCTYPE html>
<html>
<head>
  <title>WebContainer Host</title>
  <style>
    body { font-family: sans-serif; padding: 1em; }
    #status { padding: 0.5em; border-radius: 4px; font-weight: bold; }
    .loading { background-color: #ffc; color: #333; }
    .success { background-color: #cfc; color: #030; }
    .error { background-color: #fcc; color: #300; }
  </style>
  <script type="importmap">
    { "imports": { "@webcontainer/api": "https://esm.sh/@webcontainer/api" } }
  </script>
</head>
<body>
  <h1>Iframe Host Status</h1>
  <p><strong>Version:</strong> 3.0.0 (Single-File Logic)</p>
  <p><strong>Status:</strong> <span id="status" class="loading">Initializing...</span></p>

  <script type="module">
    // This single script now contains all logic.
    import { WebContainer } from '@webcontainer/api';

    const statusEl = document.getElementById('status');
    let webcontainerInstance = null;
    let isContainerBooted = false;
    let parentIsReady = false;

    // --- Gatekeeper Logic ---
    async function runGatekeeper() {
      if (window.crossOriginIsolated) {
        statusEl.textContent = 'Environment is isolated. Starting main logic...';
        // If we are isolated, we can proceed to the main logic.
        main();
        return;
      }

      if ('serviceWorker' in navigator) {
        statusEl.textContent = 'Registering service worker for isolation...';
        const registration = await navigator.serviceWorker.register('./coi-serviceworker.js');
        if (registration.active && !navigator.serviceWorker.controller) {
          statusEl.textContent = 'Reloading to activate isolation...';
          window.location.reload();
        }
      } else {
        statusEl.textContent = 'ERROR: Service workers not supported.';
        statusEl.className = 'error';
      }
    }

    // --- Main Application Logic ---
    function main() {
      function attemptHandshakeReply() {
        if (isContainerBooted && parentIsReady) {
          console.log('[Iframe] Both sides ready. Sending IFRAME_READY.');
          statusEl.textContent = 'Handshake complete. Ready for commands.';
          statusEl.className = 'success';
          parent.postMessage({ type: 'IFRAME_READY' }, '*');
        }
      }

      async function initializeContainer() {
        try {
          statusEl.textContent = 'Booting WebContainer...';
          console.log('[Iframe] Booting WebContainer...');
          webcontainerInstance = await WebContainer.boot();
          isContainerBooted = true;
          console.log('[Iframe] WebContainer booted.');
          attemptHandshakeReply();
        } catch (error) {
          console.error('[Iframe] WebContainer boot failed:', error);
          statusEl.textContent = `ERROR: ${error.message}`;
          statusEl.className = 'error';
          parent.postMessage({ type: 'IFRAME_BOOT_ERROR', error: error.message }, '*');
        }
      }

      async function handleCommand(command, args) {
        if (!webcontainerInstance) return;
        const process = await webcontainerInstance.spawn(command, args);
        process.output.pipeTo(new WritableStream({
          write(data) {
            parent.postMessage({ type: 'EXECUTION_LOG', log: data }, '*');
          }
        }));
        const exitCode = await process.exit;
        parent.postMessage({ type: 'EXECUTION_RESULT', exitCode }, '*');
      }

      window.addEventListener('message', (event) => {
        const { type, payload } = event.data;
        if (type === 'INIT') {
          parentIsReady = true;
          console.log('[Iframe] Received INIT signal from parent.');
          attemptHandshakeReply();
        } else if (type === 'EXECUTE_COMMAND') {
          handleCommand(payload.command, payload.args);
        }
      });

      // Start the container boot process
      initializeContainer();
    }

    // Start the entire process by running the gatekeeper first.
    runGatekeeper();
  </script>
</body>
</html>
